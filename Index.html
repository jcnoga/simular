<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noga Consultoria - Simulador Financeiro</title>
    
    <!-- Firebase SDKs (Compatibilidade v8 para uso simples via CDN) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* Reset e configura√ß√µes b√°sicas */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        /* --- TELA DE LOGIN (OVERLAY) --- */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }

        .login-box {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .login-view { display: none; animation: fadeIn 0.3s ease; }
        .login-view.active { display: block; }

        .login-box h2 { color: #4a5568; margin-bottom: 10px; }
        .login-box p { color: #718096; margin-bottom: 20px; font-size: 0.9em; }

        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;
        }

        .login-box button {
            width: 100%; padding: 12px; margin-bottom: 10px;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: transform 0.2s;
        }

        /* Bot√µes de Login */
        .btn-auth-primary { background: #667eea; color: white; }
        .btn-auth-primary:hover { background: #5a67d8; transform: translateY(-2px); }
        
        .btn-auth-google { background: #db4437; color: white; }
        .btn-auth-google:hover { background: #c53929; transform: translateY(-2px); }

        .btn-link { 
            background: none; color: #667eea; font-size: 0.9em; text-decoration: underline; 
            padding: 5px; margin: 0; width: auto; display: inline-block; 
        }
        .btn-link:hover { transform: none; color: #4c51bf; }

        .divider { margin: 15px 0; border-top: 1px solid #e2e8f0; position: relative; }
        .divider span { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #a0aec0; font-size: 0.8em; }

        .auth-error { color: #e53e3e; margin-bottom: 15px; font-size: 0.9em; min-height: 20px; display: none; }
        .auth-success { color: green; margin-bottom: 15px; font-size: 0.9em; display: none; }

        /* --- CONTAINER PRINCIPAL (App) --- */
        .container {
            max-width: 1400px; margin: 0 auto; padding: 20px;
            display: none; /* Escondido at√© login */
        }

        /* Header e User Info */
        .header {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); text-align: center; position: relative;
        }

        .brand-header {
            position: absolute; left: 30px; top: 30px;
            font-size: 1.2em; font-weight: 700; color: #4a5568; letter-spacing: 0.5px;
        }

        /* Controles de Usu√°rio no Header */
        .user-controls {
            position: absolute; right: 30px; top: 30px;
            display: flex; gap: 15px; align-items: center;
        }
        
        .user-email { font-size: 0.9em; color: #4a5568; font-weight: 600; display: none; }
        @media (min-width: 768px) { .user-email { display: block; } }

        .btn-logout {
            background: #e53e3e; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: bold;
        }
        .btn-logout:hover { background: #c53030; }

        .header h1 { color: #4a5568; margin-bottom: 10px; font-size: 2.2em; }
        .header p { color: #718096; font-size: 1.1em; }

        /* Layout principal */
        .main-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }

        /* Pain√©is e Cards */
        .input-panel, .dashboard, .reports-section, .charts-section, .periods-section, .help-section {
            background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); margin-bottom: 20px;
        }
        
        .input-panel { height: fit-content; margin-bottom: 0; }
        
        h2 { color: #2d3748; margin-bottom: 20px; font-size: 1.5em; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .dashboard h2, .reports-section h2 { font-size: 1.8em; }

        /* Formul√°rio */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: flex; align-items: center; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 14px; }
        .tooltip { margin-left: 8px; cursor: help; color: #667eea; font-weight: bold; position: relative; }
        .tooltip:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .form-group input { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

        /* Bot√µes App */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 10px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; margin-right: 8px; margin-bottom: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(45deg, #38a169, #2f855a); }
        .btn-danger { background: linear-gradient(45deg, #e53e3e, #c53030); }
        .btn-warning { background: linear-gradient(45deg, #ed8936, #dd6b20); }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;
            border-radius: 12px; text-align: center; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease; position: relative; cursor: pointer;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .kpi-card::after { content: '‚ÑπÔ∏è'; position: absolute; top: 10px; right: 10px; font-size: 12px; opacity: 0.7; }
        .kpi-card.negative { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .kpi-card.warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .kpi-value { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
        .kpi-label { font-size: 0.9em; opacity: 0.9; }

        /* Alertas */
        .alerts { margin-bottom: 20px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 10px; font-weight: 500; display: flex; align-items: center; }
        .alert-danger { background-color: #fed7d7; border: 1px solid #fc8181; color: #c53030; }
        .alert-warning { background-color: #fed7aa; border: 1px solid #f6ad55; color: #c05621; }
        .alert-info { background-color: #bee3f8; border: 1px solid #63b3ed; color: #2c5282; }

        /* Tabelas e Gr√°ficos */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-weight: 600; }
        tr:hover { background-color: #f7fafc; }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-container { text-align: center; }
        .chart-container h3 { margin-bottom: 15px; color: #4a5568; }
        canvas { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }

        .periods-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .period-card { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; }
        .period-card:hover { border-color: #667eea; transform: translateY(-2px); }

        /* Modal Info */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; animation: fadeIn 0.3s ease; }
        .modal-header { border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.5em; color: #2d3748; font-weight: bold; }
        .close-modal { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #718096; transition: color 0.2s; }
        .close-modal:hover { color: #e53e3e; }
        .modal-body p { color: #4a5568; font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; }
        .modal-formula { background-color: #fff7ed; border-left: 4px solid #ed8936; padding: 12px; margin-bottom: 15px; border-radius: 6px; color: #2d3748; }
        .modal-formula code { display: block; margin-top: 6px; font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 1.1em; color: #c05621; }
        .modal-example { background-color: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; font-size: 0.95em; color: #2d3748; }

        .sync-status { font-size: 12px; margin-top: 10px; padding: 8px; border-radius: 4px; background: #f7fafc; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #cbd5e0; display: inline-block; }
        .status-dot.online { background-color: #48bb78; box-shadow: 0 0 5px #48bb78; }
        .status-dot.syncing { background-color: #ecc94b; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.8em; }
            .brand-header { position: static; display: block; margin-bottom: 10px; text-align: center; }
            .user-controls { position: static; justify-content: center; margin-bottom: 10px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
        }
        @media print {
            body { background: white; color: black; }
            .btn, .input-panel, .login-overlay, .user-controls { display: none; }
            .dashboard, .reports-section, .charts-section { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; margin-bottom: 20px; }
            .kpi-card { background: white !important; color: black !important; border: 1px solid #ccc; }
            .container { display: block !important; }
        }
        .mt-20 { margin-top: 20px; }
    </style>
</head>
<body>

    <!-- TELA DE AUTENTICA√á√ÉO (OVERLAY) -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            
            <!-- View: Login -->
            <div id="view-login" class="login-view active">
                <h2>üîê Noga Consultoria</h2>
                <p>Acesse seu Simulador Financeiro</p>
                
                <div class="auth-error" id="msg-error-login"></div>
                
                <input type="email" id="login-email" placeholder="E-mail" onkeypress="handleEnter(event, AppAuth.login)">
                <input type="password" id="login-password" placeholder="Senha" onkeypress="handleEnter(event, AppAuth.login)">
                
                <button class="btn-auth-primary" onclick="AppAuth.login()">Entrar</button>
                <div class="divider"><span>OU</span></div>
                <button class="btn-auth-google" onclick="AppAuth.loginGoogle()">Entrar com Google</button>
                
                <div style="margin-top: 15px;">
                    <button class="btn-link" onclick="AuthUI.show('forgot')">Esqueci minha senha</button> <br>
                    <button class="btn-link" onclick="AuthUI.show('register')">N√£o tem conta? Cadastre-se</button>
                </div>
            </div>

            <!-- View: Cadastro -->
            <div id="view-register" class="login-view">
                <h2>üìù Criar Conta</h2>
                <p>Preencha os dados abaixo</p>
                
                <div class="auth-error" id="msg-error-register"></div>

                <!-- NOVO CAMPO DE NOME -->
                <input type="text" id="reg-name" placeholder="Seu Nome Completo">
                <input type="email" id="reg-email" placeholder="E-mail">
                <input type="password" id="reg-password" placeholder="Senha (m√≠n. 6 caracteres)">
                <input type="password" id="reg-confirm" placeholder="Confirmar Senha">
                
                <button class="btn-auth-primary" onclick="AppAuth.register()">Cadastrar</button>
                
                <div style="margin-top: 15px;">
                    <button class="btn-link" onclick="AuthUI.show('login')">J√° tenho conta. Entrar</button>
                </div>
            </div>

            <!-- View: Esqueci Senha -->
            <div id="view-forgot" class="login-view">
                <h2>üîë Recuperar Senha</h2>
                <p>Enviaremos um link para seu e-mail</p>
                
                <div class="auth-success" id="msg-success-forgot"></div>
                <div class="auth-error" id="msg-error-forgot"></div>

                <input type="email" id="forgot-email" placeholder="Seu E-mail de cadastro">
                
                <button class="btn-auth-primary" onclick="AppAuth.resetPassword()">Enviar Link</button>
                
                <div style="margin-top: 15px;">
                    <button class="btn-link" onclick="AuthUI.show('login')">Voltar para Login</button>
                </div>
            </div>

        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div class="container" id="app-container">
        <!-- Header -->
        <div class="header">
            <div class="brand-header">Noga Consultoria</div>
            
            <div class="user-controls">
                <span class="user-email" id="display-email">Carregando...</span>
                <button class="btn-logout" onclick="AppAuth.logout()">Sair</button>
            </div>

            <h1>üè™ Simulador Financeiro</h1>
            <p>Sistema de Gest√£o Financeira Simplificado para Lojas</p>
        </div>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Painel de Entradas -->
            <div class="input-panel">
                <h2>üìä Vari√°veis de Entrada</h2>
                
                <form id="financial-form">
                    <div class="form-group">
                        <label for="fv">
                            Faturamento Bruto (R$)
                            <span class="tooltip" data-tooltip="Receita total de vendas no per√≠odo">?</span>
                        </label>
                        <input type="number" id="fv" step="0.01" min="0" placeholder="Ex: 160000">
                    </div>

                    <div class="form-group">
                        <label for="ccp">
                            Custos de Compra de Produtos (R$)
                            <span class="tooltip" data-tooltip="Total gasto na compra de mercadorias para revenda">?</span>
                        </label>
                        <input type="number" id="ccp" step="0.01" min="0" placeholder="Ex: 85000">
                    </div>

                    <div class="form-group">
                        <label for="ei">
                            Estoque Inicial (R$)
                            <span class="tooltip" data-tooltip="Valor do estoque no in√≠cio do per√≠odo">?</span>
                        </label>
                        <input type="number" id="ei" step="0.01" min="0" placeholder="Ex: 20000">
                    </div>

                    <div class="form-group">
                        <label for="ef">
                            Estoque Final (R$)
                            <span class="tooltip" data-tooltip="Valor do estoque no final do per√≠odo">?</span>
                        </label>
                        <input type="number" id="ef" step="0.01" min="0" placeholder="Ex: 5000">
                    </div>

                    <div class="form-group">
                        <label for="cf">
                            Custos Fixos (R$)
                            <span class="tooltip" data-tooltip="Despesas fixas mensais (aluguel, sal√°rios, etc.)">?</span>
                        </label>
                        <input type="number" id="cf" step="0.01" min="0" placeholder="Ex: 45000">
                    </div>

                    <div class="form-group">
                        <label for="cv">
                            Custos Vari√°veis (R$)
                            <span class="tooltip" data-tooltip="Despesas que variam com as vendas (comiss√µes, fretes, etc.)">?</span>
                        </label>
                        <input type="number" id="cv" step="0.01" min="0" placeholder="Ex: 0">
                    </div>

                    <div class="form-group">
                        <label for="oc">
                            Outros Custos (R$)
                            <span class="tooltip" data-tooltip="Despesas eventuais e n√£o recorrentes">?</span>
                        </label>
                        <input type="number" id="oc" step="0.01" min="0" placeholder="Ex: 0">
                    </div>

                    <div class="form-group">
                        <label for="mk">
                            Mark-up
                            <span class="tooltip" data-tooltip="Fator multiplicador para pre√ßo de venda (ex: 1.7 = 70% de margem)">?</span>
                        </label>
                        <input type="number" id="mk" step="0.01" min="1" placeholder="Ex: 1.7">
                    </div>

                    <div class="form-group">
                        <label for="n">
                            N√∫mero de Vendas
                            <span class="tooltip" data-tooltip="Quantidade total de vendas realizadas no per√≠odo">?</span>
                        </label>
                        <input type="number" id="n" step="1" min="0" placeholder="Ex: 2500">
                    </div>

                    <div class="form-group">
                        <label for="inv">
                            Investimento Total (R$)
                            <span class="tooltip" data-tooltip="Capital total investido no neg√≥cio para c√°lculo do ROI">?</span>
                        </label>
                        <input type="number" id="inv" step="0.01" min="0" placeholder="Ex: 100000">
                    </div>

                    <div class="form-group">
                        <label for="entradas">
                            Entradas no Per√≠odo (R$)
                            <span class="tooltip" data-tooltip="Total de dinheiro que entrou no caixa">?</span>
                        </label>
                        <input type="number" id="entradas" step="0.01" min="0" placeholder="Ex: 160000">
                    </div>

                    <div class="form-group">
                        <label for="saidas">
                            Sa√≠das no Per√≠odo (R$)
                            <span class="tooltip" data-tooltip="Total de dinheiro que saiu do caixa">?</span>
                        </label>
                        <input type="number" id="saidas" step="0.01" min="0" placeholder="Ex: 140000">
                    </div>

                    <div class="form-group">
                        <label for="unidades-compradas">
                            Unidades Compradas (opcional)
                            <span class="tooltip" data-tooltip="Quantidade de produtos comprados para c√°lculo de pre√ßo sugerido">?</span>
                        </label>
                        <input type="number" id="unidades-compradas" step="1" min="0" placeholder="Ex: 1000">
                    </div>
                </form>

                <div class="mt-20">
                    <button class="btn" onclick="calcularIndicadores()">üîÑ Calcular</button>
                    <button class="btn btn-success" onclick="carregarDadosExemplo()">üìù Dados de Exemplo</button>
                    <button class="btn btn-warning" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                </div>

                <div class="mt-20">
                    <h3 style="margin-bottom: 10px; color: #4a5568;">Gerenciar Per√≠odos</h3>
                    <input type="text" id="periodo-nome" placeholder="Nome do per√≠odo (ex: Janeiro 2024)" style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <button class="btn" onclick="salvarPeriodo()">üíæ Salvar Per√≠odo</button>
                </div>

                <div class="mt-20">
                    <h3 style="margin-bottom: 10px; color: #4a5568;">Importar/Exportar</h3>
                    <div class="sync-status" id="firebase-status">
                        <span class="status-dot" id="status-dot"></span>
                        <span id="status-text">Inicializando Nuvem...</span>
                    </div>
                    <br>
                    <input type="file" id="import-file" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn" onclick="importarDados()">üì• Importar JSON</button>
                    <button class="btn" onclick="exportarJSON()">üì§ Exportar JSON</button>
                    <button class="btn" onclick="exportarCSV()">üìä Exportar CSV</button>
                    <button class="btn" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="dashboard">
                <h2>üìà Dashboard - Indicadores Financeiros</h2>
                <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">‚ÑπÔ∏è Clique nos cart√µes para ver a explica√ß√£o e f√≥rmula.</p>
                
                <!-- Alertas -->
                <div class="alerts" id="alerts-container"></div>

                <!-- KPIs Grid -->
                <div class="kpi-grid" id="kpi-grid">
                    <!-- KPIs ser√£o inseridos dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Hist√≥rico de Per√≠odos -->
        <div class="periods-section">
            <h2>üìÖ Hist√≥rico de Per√≠odos</h2>
            <p style="color: #718096; margin-bottom: 15px;">Clique em um per√≠odo para carregar os dados salvos</p>
            <div class="periods-grid" id="periods-grid">
                <!-- Per√≠odos salvos ser√£o inseridos dinamicamente -->
            </div>
        </div>

        <!-- Se√ß√£o de Relat√≥rios -->
        <div class="reports-section">
            <h2>üìã Relat√≥rio Resumo</h2>
            <div class="table-container">
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>Indicador</th>
                            <th>Valor</th>
                            <th>F√≥rmula</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados ser√£o inseridos dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-section">
            <h2>üìä Gr√°ficos</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Evolu√ß√£o Mensal</h3>
                    <canvas id="chart-evolucao" width="400" height="300"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Composi√ß√£o das Despesas</h3>
                    <canvas id="chart-despesas" width="400" height="300"></canvas>
                </div>
                <div class="chart-container">
                    <h3>CMV vs Lucro Bruto</h3>
                    <canvas id="chart-cmv-lucro" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Explica√ß√£o -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">T√≠tulo</h3>
                <button class="close-modal" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalDescription">Descri√ß√£o aqui.</p>
                
                <div class="modal-formula">
                    <strong>üßÆ F√≥rmula:</strong>
                    <code id="modalFormula">F√≥rmula aqui</code>
                </div>

                <div class="modal-example">
                    <strong>üìù Exemplo pr√°tico:</strong><br>
                    <span id="modalExample">Exemplo aqui.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // CONFIGURA√á√ÉO FIREBASE
        // ====================================================================
        
        const firebaseConfig = {
          apiKey: "AIzaSyAsevkGkgVOwW_k2Se61UjlktCenI6q9wg",
          authDomain: "simulador-2abd2.firebaseapp.com",
          projectId: "simulador-2abd2",
          storageBucket: "simulador-2abd2.firebasestorage.app",
          messagingSenderId: "66391267958",
          appId: "1:66391267958:web:9c17038e70c4deb835dd57"
        };

        // Inicializa√ß√£o Global
        let db, auth;
        let currentUser = null;
        let unsubscribeSnapshot = null;

        // Dicion√°rio de explica√ß√µes e f√≥rmulas para os indicadores
        const explicacoes = {
            'fv': {
                titulo: "Faturamento Bruto",
                descricao: "√â a soma de todo o dinheiro que entrou no caixa exclusivamente atrav√©s das vendas dos seus produtos ou servi√ßos, antes de descontar qualquer custo.",
                formula: "Soma das Vendas",
                exemplo: "Se voc√™ vendeu 10 camisetas a R$ 50,00 cada, seu Faturamento Bruto √© R$ 500,00."
            },
            'cmv': {
                titulo: "Custo das Mercadorias Vendidas (CMV)",
                descricao: "Quanto a sua empresa gastou para comprar ou produzir exatamente os produtos que foram vendidos neste per√≠odo.",
                formula: "Estoque Inicial + Compras - Estoque Final",
                exemplo: "Se voc√™ vendeu uma camiseta por R$ 50,00, mas pagou R$ 20,00 para o fornecedor por ela, seu CMV √© R$ 20,00."
            },
            'lb': {
                titulo: "Lucro Bruto",
                descricao: "√â o que sobra do dinheiro das vendas depois de pagar apenas o custo do produto. Serve para pagar as outras contas da empresa (aluguel, luz, etc.).",
                formula: "Faturamento - CMV",
                exemplo: "Vendeu por R$ 500,00 e os produtos custaram R$ 200,00. Lucro Bruto = R$ 300,00."
            },
            'dt': {
                titulo: "Despesas Totais",
                descricao: "A soma de todos os gastos para manter a empresa funcionando, incluindo aluguel, sal√°rios, contas de luz, comiss√µes e imprevistos.",
                formula: "Custos Fixos + Custos Vari√°veis + Outros Custos",
                exemplo: "Aluguel (R$ 1000) + Luz (R$ 200) + Sal√°rio (R$ 1500) = Despesas Totais de R$ 2700,00."
            },
            'll': {
                titulo: "Lucro L√≠quido",
                descricao: "√â o dinheiro que realmente sobra no bolso da empresa depois de pagar TUDO (fornecedores, aluguel, funcion√°rios, impostos).",
                formula: "Lucro Bruto - Despesas Totais",
                exemplo: "Se entrou R$ 5000,00 e voc√™ gastou R$ 4000,00 com tudo, seu Lucro L√≠quido √© R$ 1000,00."
            },
            'mlb': {
                titulo: "Margem Bruta",
                descricao: "Porcentagem que mostra quanto voc√™ ganha em cima do produto. Indica a efici√™ncia na compra e venda.",
                formula: "(Lucro Bruto √∑ Faturamento) √ó 100",
                exemplo: "Uma margem bruta de 40% significa que de cada R$ 100,00 vendidos, R$ 40,00 sobram para pagar as despesas fixas."
            },
            'mll': {
                titulo: "Margem L√≠quida",
                descricao: "Porcentagem final de lucro real sobre as vendas. Mostra a sa√∫de financeira verdadeira do neg√≥cio.",
                formula: "(Lucro L√≠quido √∑ Faturamento) √ó 100",
                exemplo: "Margem l√≠quida de 10% significa que a cada R$ 100,00 que entra no caixa, R$ 10,00 √© lucro limpo."
            },
            'mc': {
                titulo: "Margem de Contribui√ß√£o",
                descricao: "√â o quanto sobra de cada venda para pagar as despesas fixas (aluguel, sal√°rios fixos) e gerar lucro, depois de descontar os custos vari√°veis.",
                formula: "((Faturamento - Vari√°veis - CMV) √∑ Faturamento) √ó 100",
                exemplo: "Se sobra R$ 30,00 de cada produto para pagar o aluguel, essa √© sua margem de contribui√ß√£o unit√°ria."
            },
            'pe': {
                titulo: "Ponto de Equil√≠brio",
                descricao: "√â o valor m√≠nimo que voc√™ precisa vender no m√™s para n√£o ter preju√≠zo. Nesse ponto, o lucro √© zero (empata), mas todas as contas s√£o pagas.",
                formula: "Custos Fixos √∑ (Margem de Contribui√ß√£o √∑ 100)",
                exemplo: "Se seu Ponto de Equil√≠brio √© R$ 10.000,00, voc√™ s√≥ come√ßa a ter lucro a partir da venda de R$ 10.001,00."
            },
            'em': {
                titulo: "Estoque M√©dio",
                descricao: "O valor m√©dio em dinheiro de mercadorias paradas na sua loja durante o per√≠odo.",
                formula: "(Estoque Inicial + Estoque Final) √∑ 2",
                exemplo: "Come√ßou o m√™s com R$ 20.000 e terminou com R$ 10.000. Estoque m√©dio = R$ 15.000."
            },
            'ge': {
                titulo: "Giro de Estoque",
                descricao: "Quantas vezes voc√™ vendeu e rep√¥s seu estoque inteiro no per√≠odo. Quanto maior, melhor (significa que o produto n√£o fica encalhado).",
                formula: "CMV √∑ Estoque M√©dio",
                exemplo: "Giro de 2x significa que voc√™ renovou seu estoque duas vezes nesse per√≠odo."
            },
            'tm': {
                titulo: "Ticket M√©dio",
                descricao: "O valor m√©dio que cada cliente gasta quando compra na sua loja.",
                formula: "Faturamento √∑ N√∫mero de Vendas",
                exemplo: "Se o Ticket M√©dio √© R$ 150,00, significa que, na m√©dia, cada venda realizada foi nesse valor."
            },
            'fc': {
                titulo: "Fluxo de Caixa",
                descricao: "A diferen√ßa simples entre todo o dinheiro que entrou e todo o dinheiro que saiu da conta no per√≠odo. Mostra a disponibilidade imediata de dinheiro.",
                formula: "Entradas - Sa√≠das",
                exemplo: "Entrou R$ 5.000 e saiu R$ 4.500. Fluxo de Caixa positivo de R$ 500,00."
            },
            'roi': {
                titulo: "ROI (Retorno sobre Investimento)",
                descricao: "Porcentagem que diz quanto voc√™ ganhou em rela√ß√£o ao que investiu inicialmente no neg√≥cio.",
                formula: "(Lucro L√≠quido √∑ Investimento Total) √ó 100",
                exemplo: "ROI de 10% significa que para cada R$ 100,00 investidos, voc√™ recuperou os R$ 100,00 e ganhou mais R$ 10,00."
            },
            'precoSugerido': {
                titulo: "Pre√ßo Sugerido M√©dio",
                descricao: "Valor de venda recomendado para seus produtos baseado no Mark-up (margem) que voc√™ definiu.",
                formula: "(Custo Unit√°rio √ó Mark-up)",
                exemplo: "Se o produto custa R$ 50,00 e o mark-up √© 2.0, o pre√ßo sugerido √© R$ 100,00."
            }
        };

        // Vari√°veis globais para armazenar dados
        let dadosFinanceiros = {};
        let periodosHistorico = JSON.parse(localStorage.getItem('erp_simulafinanc_v1_periodos')) || [];
        let dadosCalculados = {};

        // Fun√ß√µes do Modal
        function mostrarExplicacao(chave) {
            const dados = explicacoes[chave];
            if (dados) {
                document.getElementById('modalTitle').textContent = dados.titulo;
                document.getElementById('modalDescription').textContent = dados.descricao;
                document.getElementById('modalFormula').textContent = dados.formula;
                document.getElementById('modalExample').textContent = dados.exemplo;
                
                document.getElementById('infoModal').style.display = 'flex';
            }
        }

        function fecharModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target === modal) {
                fecharModal();
            }
        }

        // Fun√ß√£o para formatar valores monet√°rios
        function formatarMoeda(valor) {
            if (isNaN(valor) || valor === null || valor === undefined) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL' 
            }).format(valor);
        }

        // Fun√ß√£o para formatar percentuais
        function formatarPercentual(valor) {
            if (isNaN(valor) || valor === null || valor === undefined) return '0,00%';
            return new Intl.NumberFormat('pt-BR', { 
                style: 'percent', 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valor / 100);
        }

        // Fun√ß√£o para obter valores do formul√°rio
        function obterDadosFormulario() {
            return {
                fv: parseFloat(document.getElementById('fv').value) || 0,           // Faturamento Bruto
                ccp: parseFloat(document.getElementById('ccp').value) || 0,         // Custos de Compra de Produtos
                ei: parseFloat(document.getElementById('ei').value) || 0,           // Estoque Inicial
                ef: parseFloat(document.getElementById('ef').value) || 0,           // Estoque Final
                cf: parseFloat(document.getElementById('cf').value) || 0,           // Custos Fixos
                cv: parseFloat(document.getElementById('cv').value) || 0,           // Custos Vari√°veis
                oc: parseFloat(document.getElementById('oc').value) || 0,           // Outros Custos
                mk: parseFloat(document.getElementById('mk').value) || 1.7,         // Mark-up
                n: parseInt(document.getElementById('n').value) || 0,               // N√∫mero de Vendas
                inv: parseFloat(document.getElementById('inv').value) || 0,         // Investimento Total
                entradas: parseFloat(document.getElementById('entradas').value) || 0, // Entradas no Per√≠odo
                saidas: parseFloat(document.getElementById('saidas').value) || 0,   // Sa√≠das no Per√≠odo
                unidadesCompradas: parseInt(document.getElementById('unidades-compradas').value) || 0 // Unidades Compradas
            };
        }

        // Fun√ß√£o para preencher o formul√°rio com dados
        function preencherFormulario(dados) {
            document.getElementById('fv').value = dados.fv || '';
            document.getElementById('ccp').value = dados.ccp || '';
            document.getElementById('ei').value = dados.ei || '';
            document.getElementById('ef').value = dados.ef || '';
            document.getElementById('cf').value = dados.cf || '';
            document.getElementById('cv').value = dados.cv || '';
            document.getElementById('oc').value = dados.oc || '';
            document.getElementById('mk').value = dados.mk || '';
            document.getElementById('n').value = dados.n || '';
            document.getElementById('inv').value = dados.inv || '';
            document.getElementById('entradas').value = dados.entradas || '';
            document.getElementById('saidas').value = dados.saidas || '';
            document.getElementById('unidades-compradas').value = dados.unidadesCompradas || '';
        }

        // Fun√ß√£o principal para calcular todos os indicadores
        function calcularIndicadores() {
            dadosFinanceiros = obterDadosFormulario();
            
            // 1. CMV = EI + CCP - EF (Custo das Mercadorias Vendidas)
            const cmv = dadosFinanceiros.ei + dadosFinanceiros.ccp - dadosFinanceiros.ef;
            
            // 2. LB = FV - CMV (Lucro Bruto)
            const lb = dadosFinanceiros.fv - cmv;
            
            // 3. MLB = (LB / FV) √ó 100 (Margem Bruta %)
            const mlb = dadosFinanceiros.fv > 0 ? (lb / dadosFinanceiros.fv) * 100 : 0;
            
            // 4. DT = CF + CV + OC (Despesas Totais)
            const dt = dadosFinanceiros.cf + dadosFinanceiros.cv + dadosFinanceiros.oc;
            
            // 5. LL = LB - DT (Lucro L√≠quido)
            const ll = lb - dt;
            
            // 6. MLL = (LL / FV) √ó 100 (Margem L√≠quida %)
            const mll = dadosFinanceiros.fv > 0 ? (ll / dadosFinanceiros.fv) * 100 : 0;
            
            // 7. MC = [(FV - CV - CMV) / FV] √ó 100 (Margem de Contribui√ß√£o %)
            const mc = dadosFinanceiros.fv > 0 ? ((dadosFinanceiros.fv - dadosFinanceiros.cv - cmv) / dadosFinanceiros.fv) * 100 : 0;
            
            // 8. PE = CF / (MC √∑ 100) (Ponto de Equil√≠brio R$)
            const pe = mc > 0 ? dadosFinanceiros.cf / (mc / 100) : 0;
            
            // 9. EM = (EI + EF) / 2 (Estoque M√©dio)
            const em = (dadosFinanceiros.ei + dadosFinanceiros.ef) / 2;
            
            // 10. GE = CMV / EM (Giro de Estoque)
            const ge = em > 0 ? cmv / em : 0;
            
            // 11. TM = FV / N (Ticket M√©dio)
            const tm = dadosFinanceiros.n > 0 ? dadosFinanceiros.fv / dadosFinanceiros.n : 0;
            
            // 12. FC = Entradas - Sa√≠das (Fluxo de Caixa)
            const fc = dadosFinanceiros.entradas - dadosFinanceiros.saidas;
            
            // 13. ROI = (LL / INV) √ó 100 (Retorno sobre Investimento %)
            const roi = dadosFinanceiros.inv > 0 ? (ll / dadosFinanceiros.inv) * 100 : 0;
            
            // 14. Pre√ßo sugerido m√©dio (opcional)
            const precoSugerido = dadosFinanceiros.unidadesCompradas > 0 ? 
                (dadosFinanceiros.ccp / dadosFinanceiros.unidadesCompradas) * dadosFinanceiros.mk : 0;

            // Armazenar dados calculados
            dadosCalculados = {
                cmv, lb, mlb, dt, ll, mll, mc, pe, em, ge, tm, fc, roi, precoSugerido
            };

            // Atualizar interface
            atualizarDashboard();
            atualizarAlertas();
            atualizarTabelaResumo();
            atualizarGraficos();
            
            // Salvar no localStorage
            localStorage.setItem('erp_simulafinanc_v1', JSON.stringify({
                dados: dadosFinanceiros,
                calculados: dadosCalculados,
                timestamp: new Date().toISOString()
            }));

            // Sync with Firebase
            syncWithFirebase();
        }

        // Fun√ß√£o para atualizar o dashboard com KPIs
        function atualizarDashboard() {
            const kpiGrid = document.getElementById('kpi-grid');
            
            const kpis = [
                { label: 'Faturamento Bruto', value: formatarMoeda(dadosFinanceiros.fv), key: 'fv' },
                { label: 'Custo Mercadorias Vendidas', value: formatarMoeda(dadosCalculados.cmv), key: 'cmv' },
                { label: 'Lucro Bruto', value: formatarMoeda(dadosCalculados.lb), key: 'lb', isProfit: true },
                { label: 'Despesas Totais', value: formatarMoeda(dadosCalculados.dt), key: 'dt' },
                { label: 'Lucro L√≠quido', value: formatarMoeda(dadosCalculados.ll), key: 'll', isProfit: true },
                { label: 'Margem Bruta', value: formatarPercentual(dadosCalculados.mlb), key: 'mlb', isPercent: true },
                { label: 'Margem L√≠quida', value: formatarPercentual(dadosCalculados.mll), key: 'mll', isPercent: true },
                { label: 'Margem de Contribui√ß√£o', value: formatarPercentual(dadosCalculados.mc), key: 'mc', isPercent: true },
                { label: 'Ponto de Equil√≠brio', value: formatarMoeda(dadosCalculados.pe), key: 'pe' },
                { label: 'Estoque M√©dio', value: formatarMoeda(dadosCalculados.em), key: 'em' },
                { label: 'Giro de Estoque', value: dadosCalculados.ge.toFixed(2) + 'x', key: 'ge' },
                { label: 'Ticket M√©dio', value: formatarMoeda(dadosCalculados.tm), key: 'tm' },
                { label: 'Fluxo de Caixa', value: formatarMoeda(dadosCalculados.fc), key: 'fc', isProfit: true },
                { label: 'ROI', value: formatarPercentual(dadosCalculados.roi), key: 'roi', isPercent: true }
            ];

            if (dadosCalculados.precoSugerido > 0) {
                kpis.push({ label: 'Pre√ßo Sugerido M√©dio', value: formatarMoeda(dadosCalculados.precoSugerido), key: 'precoSugerido' });
            }

            kpiGrid.innerHTML = '';
            kpis.forEach(kpi => {
                const kpiCard = document.createElement('div');
                kpiCard.classList.add('kpi-card');
                
                // Adicionar evento de clique para abrir o modal
                kpiCard.onclick = function() {
                    mostrarExplicacao(kpi.key);
                };
                
                // Aplicar classes condicionais baseadas no valor
                if (kpi.isProfit) {
                    const valor = kpi.key === 'lb' ? dadosCalculados.lb : 
                                  kpi.key === 'll' ? dadosCalculados.ll : 
                                  dadosCalculados.fc;
                    if (valor < 0) kpiCard.classList.add('negative');
                } else if (kpi.isPercent) {
                    const valor = kpi.key === 'mlb' ? dadosCalculados.mlb :
                                  kpi.key === 'mll' ? dadosCalculados.mll :
                                  dadosCalculados.roi;
                    if (valor < 0) kpiCard.classList.add('negative');
                    else if (valor < 10 && kpi.key !== 'roi') kpiCard.classList.add('warning');
                }
                
                kpiCard.innerHTML = `
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-label">${kpi.label}</div>
                `;
                kpiGrid.appendChild(kpiCard);
            });
        }

        // Fun√ß√£o para atualizar alertas
        function atualizarAlertas() {
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = '';

            // Alerta: Vendas abaixo do ponto de equil√≠brio
            if (dadosFinanceiros.fv > 0 && dadosCalculados.pe > 0 && dadosFinanceiros.fv < dadosCalculados.pe) {
                const alert = document.createElement('div');
                alert.classList.add('alert', 'alert-danger');
                alert.innerHTML = `üö® <strong>Aten√ß√£o:</strong> Vendas abaixo do ponto de equil√≠brio! Voc√™ precisa vender pelo menos ${formatarMoeda(dadosCalculados.pe)} para cobrir os custos fixos.`;
                alertsContainer.appendChild(alert);
            }

            // Alerta: Fluxo de caixa negativo
            if (dadosCalculados.fc < 0) {
                const alert = document.createElement('div');
                alert.classList.add('alert', 'alert-danger');
                alert.innerHTML = `üí∏ <strong>Fluxo de caixa negativo:</strong> Sa√≠das superiores √†s entradas em ${formatarMoeda(Math.abs(dadosCalculados.fc))}.`;
                alertsContainer.appendChild(alert);
            }

            // Alerta: Margem de contribui√ß√£o <= 0
            if (dadosCalculados.mc <= 0) {
                const alert = document.createElement('div');
                alert.classList.add('alert', 'alert-warning');
                alert.innerHTML = `‚ö†Ô∏è <strong>Margem de contribui√ß√£o baixa ou negativa:</strong> Ponto de equil√≠brio indefinido. Revise seus custos vari√°veis e pre√ßos.`;
                alertsContainer.appendChild(alert);
            }

            // Alerta: Margem l√≠quida baixa
            if (dadosCalculados.mll > 0 && dadosCalculados.mll < 5) {
                const alert = document.createElement('div');
                alert.classList.add('alert', 'alert-warning');
                alert.innerHTML = `üìä <strong>Margem l√≠quida baixa:</strong> ${formatarPercentual(dadosCalculados.mll)}. Considere otimizar custos ou aumentar pre√ßos.`;
                alertsContainer.appendChild(alert);
            }

            // Alerta: ROI negativo
            if (dadosCalculados.roi < 0) {
                const alert = document.createElement('div');
                alert.classList.add('alert', 'alert-danger');
                alert.innerHTML = `üìâ <strong>ROI negativo:</strong> O investimento n√£o est√° gerando retorno positivo.`;
                alertsContainer.appendChild(alert);
            }
        }

        // Fun√ß√£o para atualizar tabela resumo
        function atualizarTabelaResumo() {
            const tbody = document.querySelector('#summary-table tbody');
            
            const resumo = [
                { indicador: 'Faturamento Bruto (FV)', valor: formatarMoeda(dadosFinanceiros.fv), formula: 'Receita total de vendas' },
                { indicador: 'Custo Mercadorias Vendidas (CMV)', valor: formatarMoeda(dadosCalculados.cmv), formula: 'EI + CCP - EF' },
                { indicador: 'Lucro Bruto (LB)', valor: formatarMoeda(dadosCalculados.lb), formula: 'FV - CMV' },
                { indicador: 'Despesas Totais (DT)', valor: formatarMoeda(dadosCalculados.dt), formula: 'CF + CV + OC' },
                { indicador: 'Lucro L√≠quido (LL)', valor: formatarMoeda(dadosCalculados.ll), formula: 'LB - DT' },
                { indicador: 'Margem Bruta (%)', valor: formatarPercentual(dadosCalculados.mlb), formula: '(LB / FV) √ó 100' },
                { indicador: 'Margem L√≠quida (%)', valor: formatarPercentual(dadosCalculados.mll), formula: '(LL / FV) √ó 100' },
                { indicador: 'Margem de Contribui√ß√£o (%)', valor: formatarPercentual(dadosCalculados.mc), formula: '[(FV - CV - CMV) / FV] √ó 100' },
                { indicador: 'Ponto de Equil√≠brio (R$)', valor: formatarMoeda(dadosCalculados.pe), formula: 'CF / (MC √∑ 100)' },
                { indicador: 'Estoque M√©dio', valor: formatarMoeda(dadosCalculados.em), formula: '(EI + EF) / 2' },
                { indicador: 'Giro de Estoque', valor: dadosCalculados.ge.toFixed(2) + 'x', formula: 'CMV / EM' },
                { indicador: 'Ticket M√©dio', valor: formatarMoeda(dadosCalculados.tm), formula: 'FV / N' },
                { indicador: 'Fluxo de Caixa', valor: formatarMoeda(dadosCalculados.fc), formula: 'Entradas - Sa√≠das' },
                { indicador: 'ROI (%)', valor: formatarPercentual(dadosCalculados.roi), formula: '(LL / INV) √ó 100' }
            ];

            tbody.innerHTML = '';
            resumo.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${item.indicador}</strong></td>
                    <td>${item.valor}</td>
                    <td><em>${item.formula}</em></td>
                `;
            });
        }

        // Fun√ß√£o para carregar dados de exemplo
        function carregarDadosExemplo() {
            const dadosExemplo = {
                fv: 160000,
                ccp: 85000,
                ei: 20000,
                ef: 5000,
                cf: 45000,
                cv: 0,
                oc: 0,
                mk: 1.7,
                n: 2500,
                inv: 100000,
                entradas: 160000,
                saidas: 140000,
                unidadesCompradas: 1000
            };

            preencherFormulario(dadosExemplo);
            calcularIndicadores();
        }

        // Fun√ß√£o para limpar formul√°rio
        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                document.getElementById('financial-form').reset();
                document.getElementById('kpi-grid').innerHTML = '';
                document.getElementById('alerts-container').innerHTML = '';
                document.querySelector('#summary-table tbody').innerHTML = '';
                limparGraficos();
                
                // Sincroniza estado limpo (mas n√£o deleta hist√≥rico para seguran√ßa, a menos que o usu√°rio exclua os cards)
                syncWithFirebase();
            }
        }

        // Fun√ß√£o para salvar per√≠odo
        function salvarPeriodo() {
            const nome = document.getElementById('periodo-nome').value.trim();
            if (!nome) {
                alert('Por favor, insira um nome para o per√≠odo.');
                return;
            }

            if (Object.keys(dadosFinanceiros).length === 0) {
                alert('Calcule os indicadores antes de salvar o per√≠odo.');
                return;
            }

            const periodo = {
                id: Date.now(),
                nome: nome,
                dados: { ...dadosFinanceiros },
                calculados: { ...dadosCalculados },
                timestamp: new Date().toISOString()
            };

            // Manter apenas os √∫ltimos 12 per√≠odos
            periodosHistorico.unshift(periodo);
            if (periodosHistorico.length > 12) {
                periodosHistorico = periodosHistorico.slice(0, 12);
            }

            localStorage.setItem('erp_simulafinanc_v1_periodos', JSON.stringify(periodosHistorico));
            document.getElementById('periodo-nome').value = '';
            atualizarHistoricoPeriodos();
            
            // Sync Firebase
            syncWithFirebase();
            
            alert('Per√≠odo salvo com sucesso!');
        }

        // Fun√ß√£o para atualizar hist√≥rico de per√≠odos
        function atualizarHistoricoPeriodos() {
            const periodsGrid = document.getElementById('periods-grid');
            periodsGrid.innerHTML = '';

            if (periodosHistorico.length === 0) {
                periodsGrid.innerHTML = '<p style="color: #718096; text-align: center; grid-column: 1 / -1;">Nenhum per√≠odo salvo ainda.</p>';
                return;
            }

            periodosHistorico.forEach(periodo => {
                const periodCard = document.createElement('div');
                periodCard.classList.add('period-card');
                periodCard.innerHTML = `
                    <h4 style="margin-bottom: 8px; color: #4a5568;">${periodo.nome}</h4>
                    <p style="font-size: 12px; color: #718096; margin-bottom: 8px;">
                        ${new Date(periodo.timestamp).toLocaleDateString('pt-BR')}
                    </p>
                    <p style="font-size: 14px; color: #2d3748;">
                        <strong>Faturamento:</strong> ${formatarMoeda(periodo.dados.fv)}<br>
                        <strong>Lucro L√≠quido:</strong> ${formatarMoeda(periodo.calculados.ll)}
                    </p>
                    <div style="margin-top: 10px;">
                        <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="carregarPeriodo(${periodo.id})">Carregar</button>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;" onclick="excluirPeriodo(${periodo.id})">Excluir</button>
                    </div>
                `;
                periodsGrid.appendChild(periodCard);
            });
        }

        // Fun√ß√£o para carregar per√≠odo espec√≠fico
        function carregarPeriodo(id) {
            const periodo = periodosHistorico.find(p => p.id === id);
            if (periodo) {
                preencherFormulario(periodo.dados);
                dadosFinanceiros = { ...periodo.dados };
                dadosCalculados = { ...periodo.calculados };
                atualizarDashboard();
                atualizarAlertas();
                atualizarTabelaResumo();
                atualizarGraficos();
                // Sincroniza o estado "atual" carregado
                syncWithFirebase();
            }
        }

        // Fun√ß√£o para excluir per√≠odo
        function excluirPeriodo(id) {
            if (confirm('Tem certeza que deseja excluir este per√≠odo?')) {
                periodosHistorico = periodosHistorico.filter(p => p.id !== id);
                localStorage.setItem('erp_simulafinanc_v1_periodos', JSON.stringify(periodosHistorico));
                atualizarHistoricoPeriodos();
                syncWithFirebase();
            }
        }

        // Fun√ß√£o para exportar dados em JSON
        function exportarJSON() {
            const dadosExport = {
                dadosAtuais: {
                    dados: dadosFinanceiros,
                    calculados: dadosCalculados
                },
                historicoPeriodos: periodosHistorico,
                exportadoEm: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(dadosExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `erp-financeiro-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Fun√ß√£o para importar dados JSON
        function importarDados() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo JSON.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    
                    if (dadosImportados.dadosAtuais) {
                        preencherFormulario(dadosImportados.dadosAtuais.dados);
                        dadosFinanceiros = { ...dadosImportados.dadosAtuais.dados };
                        dadosCalculados = { ...dadosImportados.dadosAtuais.calculados };
                        atualizarDashboard();
                        atualizarAlertas();
                        atualizarTabelaResumo();
                        atualizarGraficos();
                    }
                    
                    if (dadosImportados.historicoPeriodos) {
                        periodosHistorico = dadosImportados.historicoPeriodos;
                        localStorage.setItem('erp_simulafinanc_v1_periodos', JSON.stringify(periodosHistorico));
                        atualizarHistoricoPeriodos();
                    }
                    
                    syncWithFirebase();
                    alert('Dados importados com sucesso!');
                } catch (error) {
                    alert('Erro ao importar dados. Verifique se o arquivo √© um JSON v√°lido.');
                }
            };
            reader.readAsText(file);
        }

        // Fun√ß√£o para exportar CSV
        function exportarCSV() {
            if (Object.keys(dadosCalculados).length === 0) {
                alert('Calcule os indicadores antes de exportar.');
                return;
            }

            const headers = [
                'Indicador', 'Valor', 'F√≥rmula'
            ];

            const dados = [
                ['Faturamento Bruto', dadosFinanceiros.fv, 'Receita total de vendas'],
                ['Custo Mercadorias Vendidas', dadosCalculados.cmv, 'EI + CCP - EF'],
                ['Lucro Bruto', dadosCalculados.lb, 'FV - CMV'],
                ['Despesas Totais', dadosCalculados.dt, 'CF + CV + OC'],
                ['Lucro L√≠quido', dadosCalculados.ll, 'LB - DT'],
                ['Margem Bruta (%)', dadosCalculados.mlb, '(LB / FV) √ó 100'],
                ['Margem L√≠quida (%)', dadosCalculados.mll, '(LL / FV) √ó 100'],
                ['Margem de Contribui√ß√£o (%)', dadosCalculados.mc, '[(FV - CV - CMV) / FV] √ó 100'],
                ['Ponto de Equil√≠brio', dadosCalculados.pe, 'CF / (MC √∑ 100)'],
                ['Estoque M√©dio', dadosCalculados.em, '(EI + EF) / 2'],
                ['Giro de Estoque', dadosCalculados.ge, 'CMV / EM'],
                ['Ticket M√©dio', dadosCalculados.tm, 'FV / N'],
                ['Fluxo de Caixa', dadosCalculados.fc, 'Entradas - Sa√≠das'],
                ['ROI (%)', dadosCalculados.roi, '(LL / INV) √ó 100']
            ];

            const csvContent = [headers, ...dados]
                .map(row => row.map(cell => `"${cell}"`).join(';'))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio-financeiro-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Fun√ß√£o para imprimir relat√≥rio
        function imprimirRelatorio() {
            window.print();
        }

        // Fun√ß√µes para gr√°ficos em canvas
        function atualizarGraficos() {
            desenharGraficoEvolucao();
            desenharGraficoDespesas();
            desenharGraficoCMVLucro();
        }

        function limparGraficos() {
            const canvases = ['chart-evolucao', 'chart-despesas', 'chart-cmv-lucro'];
            canvases.forEach(id => {
                const canvas = document.getElementById(id);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }

        // Gr√°fico de evolu√ß√£o mensal (√∫ltimos per√≠odos salvos)
        function desenharGraficoEvolucao() {
            const canvas = document.getElementById('chart-evolucao');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (periodosHistorico.length === 0) {
                ctx.fillStyle = '#718096';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Salve per√≠odos para ver a evolu√ß√£o', canvas.width / 2, canvas.height / 2);
                return;
            }

            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;

            // Dados dos √∫ltimos per√≠odos (m√°ximo 6 para visualiza√ß√£o)
            const dadosGrafico = periodosHistorico.slice(0, 6).reverse();
            const maxFV = Math.max(...dadosGrafico.map(p => p.dados.fv));
            const maxLL = Math.max(...dadosGrafico.map(p => Math.abs(p.calculados.ll)));
            const maxValue = Math.max(maxFV, maxLL);

            // Desenhar eixos
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();

            // Desenhar linhas do gr√°fico
            if (dadosGrafico.length > 1) {
                const stepX = chartWidth / (dadosGrafico.length - 1);

                // Linha do Faturamento
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                dadosGrafico.forEach((periodo, index) => {
                    const x = margin + index * stepX;
                    const y = canvas.height - margin - (periodo.dados.fv / maxValue) * chartHeight;
                    if (index === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Linha do Lucro L√≠quido
                ctx.strokeStyle = '#38a169';
                ctx.lineWidth = 3;
                ctx.beginPath();
                dadosGrafico.forEach((periodo, index) => {
                    const x = margin + index * stepX;
                    const y = canvas.height - margin - (Math.max(0, periodo.calculados.ll) / maxValue) * chartHeight;
                    if (index === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Legenda
            ctx.fillStyle = '#667eea';
            ctx.fillRect(margin, 10, 15, 15);
            ctx.fillStyle = '#4a5568';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Faturamento', margin + 20, 22);

            ctx.fillStyle = '#38a169';
            ctx.fillRect(margin + 120, 10, 15, 15);
            ctx.fillText('Lucro L√≠quido', margin + 145, 22);
        }

        // Gr√°fico de composi√ß√£o das despesas (pizza)
        function desenharGraficoDespesas() {
            const canvas = document.getElementById('chart-despesas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (dadosCalculados.dt === 0) {
                ctx.fillStyle = '#718096';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhuma despesa informada', canvas.width / 2, canvas.height / 2);
                return;
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;

            const despesas = [
                { label: 'Custos Fixos', valor: dadosFinanceiros.cf, cor: '#e53e3e' },
                { label: 'Custos Vari√°veis', valor: dadosFinanceiros.cv, cor: '#ed8936' },
                { label: 'Outros Custos', valor: dadosFinanceiros.oc, cor: '#667eea' }
            ].filter(d => d.valor > 0);

            let startAngle = -Math.PI / 2;

            despesas.forEach((despesa, index) => {
                const sliceAngle = (despesa.valor / dadosCalculados.dt) * 2 * Math.PI;
                
                // Desenhar fatia
                ctx.fillStyle = despesa.cor;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                // Desenhar legenda
                const legendY = 20 + index * 25;
                ctx.fillStyle = despesa.cor;
                ctx.fillRect(10, legendY, 15, 15);
                ctx.fillStyle = '#4a5568';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${despesa.label}: ${formatarMoeda(despesa.valor)}`, 30, legendY + 12);

                startAngle += sliceAngle;
            });
        }

        // Gr√°fico de barras CMV vs Lucro Bruto
        function desenharGraficoCMVLucro() {
            const canvas = document.getElementById('chart-cmv-lucro');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;

            const maxValue = Math.max(dadosCalculados.cmv, Math.abs(dadosCalculados.lb));
            
            if (maxValue === 0) {
                ctx.fillStyle = '#718096';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Calcule os indicadores para ver o gr√°fico', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Desenhar eixos
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();

            // Barra CMV
            const cmvHeight = (dadosCalculados.cmv / maxValue) * chartHeight;
            ctx.fillStyle = '#e53e3e';
            ctx.fillRect(margin + 50, canvas.height - margin - cmvHeight, 80, cmvHeight);

            // Barra Lucro Bruto
            const lbHeight = Math.abs(dadosCalculados.lb / maxValue) * chartHeight;
            ctx.fillStyle = dadosCalculados.lb >= 0 ? '#38a169' : '#e53e3e';
            ctx.fillRect(margin + 150, canvas.height - margin - lbHeight, 80, lbHeight);

            // Labels
            ctx.fillStyle = '#4a5568';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CMV', margin + 90, canvas.height - margin + 20);
            ctx.fillText('Lucro Bruto', margin + 190, canvas.height - margin + 20);

            // Valores
            ctx.font = '10px Arial';
            ctx.fillText(formatarMoeda(dadosCalculados.cmv), margin + 90, canvas.height - margin - cmvHeight - 5);
            ctx.fillText(formatarMoeda(dadosCalculados.lb), margin + 190, canvas.height - margin - lbHeight - 5);
        }

        // ====================================================================
        // GEST√ÉO DE UI DE AUTENTICA√á√ÉO
        // ====================================================================
        const AuthUI = {
            show: (viewId) => {
                document.querySelectorAll('.login-view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + viewId).classList.add('active');
                
                // Limpar mensagens
                document.querySelectorAll('.auth-error').forEach(el => { el.style.display = 'none'; el.textContent = ''; });
                document.querySelectorAll('.auth-success').forEach(el => { el.style.display = 'none'; el.textContent = ''; });
            },
            showError: (viewId, msg) => {
                const el = document.getElementById('msg-error-' + viewId);
                el.textContent = msg;
                el.style.display = 'block';
                el.style.color = '#e53e3e';
            },
            showSuccess: (viewId, msg) => {
                const el = document.getElementById('msg-success-' + viewId);
                if(el) {
                    el.textContent = msg;
                    el.style.display = 'block';
                }
            }
        };

        function handleEnter(e, callback) {
            if (e.key === 'Enter') callback();
        }

        // ====================================================================
        // L√ìGICA DE AUTENTICA√á√ÉO E FIREBASE
        // ====================================================================
        const AppAuth = {
            login: () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                
                if(!email || !pass) return AuthUI.showError('login', 'Preencha e-mail e senha.');
                
                const btn = document.querySelector('#view-login .btn-auth-primary');
                btn.innerText = 'Entrando...';

                // Definir persist√™ncia como SESSION (desloga ao fechar aba)
                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(() => {
                    return firebase.auth().signInWithEmailAndPassword(email, pass);
                })
                .catch(err => {
                    AuthUI.showError('login', AppAuth.mapError(err.code));
                    btn.innerText = 'Entrar';
                });
            },
            
            register: () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-password').value;
                const conf = document.getElementById('reg-confirm').value;
                
                if(!name) return AuthUI.showError('register', 'Por favor, digite seu nome.');
                if(!email || !pass) return AuthUI.showError('register', 'Preencha todos os campos.');
                if(pass !== conf) return AuthUI.showError('register', 'Senhas n√£o conferem.');
                if(pass.length < 6) return AuthUI.showError('register', 'Senha deve ter no m√≠nimo 6 caracteres.');

                const btn = document.querySelector('#view-register .btn-auth-primary');
                const originalText = btn.innerText;
                btn.innerText = 'Criando...';

                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(() => {
                    return firebase.auth().createUserWithEmailAndPassword(email, pass);
                })
                .then((userCredential) => {
                    // Atualiza o perfil com o nome do usu√°rio
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .catch(err => {
                    AuthUI.showError('register', AppAuth.mapError(err.code));
                    btn.innerText = originalText;
                });
            },
            
            loginGoogle: () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(() => {
                    return firebase.auth().signInWithPopup(provider);
                })
                .catch(err => {
                    AuthUI.showError('login', 'Erro Google: ' + err.message);
                });
            },
            
            resetPassword: () => {
                const email = document.getElementById('forgot-email').value;
                if(!email) return AuthUI.showError('forgot', 'Digite seu e-mail cadastrado.');
                
                firebase.auth().sendPasswordResetEmail(email).then(() => {
                    AuthUI.showSuccess('forgot', 'Link enviado para o e-mail!');
                }).catch(err => {
                    AuthUI.showError('forgot', AppAuth.mapError(err.code));
                });
            },
            
            logout: () => {
                if(confirm("Deseja realmente sair?")) {
                    firebase.auth().signOut().then(() => {
                        window.location.reload(); // Recarrega para limpar estado da mem√≥ria
                    });
                }
            },
            
            mapError: (code) => {
                switch(code) {
                    case 'auth/invalid-email': return 'E-mail inv√°lido.';
                    case 'auth/user-disabled': return 'Usu√°rio desativado.';
                    case 'auth/user-not-found': return 'Usu√°rio n√£o encontrado.';
                    case 'auth/wrong-password': return 'Senha incorreta.';
                    case 'auth/email-already-in-use': return 'E-mail j√° cadastrado.';
                    case 'auth/weak-password': return 'Senha muito fraca.';
                    default: return 'Erro: ' + code;
                }
            }
        };

        function initFirebase() {
            if (firebaseConfig.apiKey === "AIzaSyAsevkGkgVOwW_k2Se61UjlktCenI6q9wg") {
                // Configura√ß√£o padr√£o detectada, prosseguir.
            }

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            db = firebase.firestore();
            auth = firebase.auth();

            // Monitorar Estado de Autentica√ß√£o
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Usu√°rio logado
                    currentUser = user;
                    
                    // Atualizar UI
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    
                    // Exibir Nome do Usu√°rio no Header (com fallback para e-mail)
                    const displayName = user.displayName || user.email;
                    document.getElementById('display-email').textContent = displayName;
                    
                    updateSyncStatus('online', 'Conectado');

                    // Iniciar Sincroniza√ß√£o de Dados
                    initDataSync(user.uid);
                } else {
                    // Usu√°rio deslogado
                    currentUser = null;
                    document.getElementById('login-overlay').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                    
                    // Resetar views de login
                    AuthUI.show('login');
                }
            });
        }

        // Sincroniza√ß√£o de Dados (Cloud -> Local na carga)
        function initDataSync(uid) {
            updateSyncStatus('syncing', 'Baixando dados...');
            
            // Cancelar listener anterior se houver
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            
            // Listener em tempo real no documento do usu√°rio
            unsubscribeSnapshot = db.collection('simulacoes').doc(uid).onSnapshot((doc) => {
                updateSyncStatus('online', 'Sincronizado');
                
                if (doc.exists && !document.hidden) {
                    const remote = doc.data();
                    let updated = false;
                    
                    // Carrega dados atuais se existirem na nuvem
                    if (remote.dadosAtuais && remote.dadosAtuais.dados) {
                        dadosFinanceiros = remote.dadosAtuais.dados;
                        dadosCalculados = remote.dadosAtuais.calculados || {};
                        preencherFormulario(dadosFinanceiros);
                        updated = true;
                    }
                    
                    // Carrega hist√≥rico se existir
                    if (remote.historico) {
                        periodosHistorico = remote.historico;
                        localStorage.setItem('erp_simulafinanc_v1_periodos', JSON.stringify(periodosHistorico));
                        atualizarHistoricoPeriodos();
                    }

                    if(updated) {
                        // Recalcula visualmente mas sem salvar novamente pra evitar loop
                        // Apenas atualiza a UI
                        const tempCalc = calcularIndicadoresSemSalvar(); 
                        atualizarDashboard();
                        atualizarAlertas();
                        atualizarTabelaResumo();
                        atualizarGraficos();
                    }
                }
            }, (error) => {
                console.error("Erro Sync:", error);
                updateSyncStatus('offline', 'Erro conex√£o');
            });
        }
        
        // Fun√ß√£o auxiliar para calcular sem disparar o sync (evita loops infinitos no onSnapshot)
        function calcularIndicadoresSemSalvar() {
             const cmv = dadosFinanceiros.ei + dadosFinanceiros.ccp - dadosFinanceiros.ef;
             const lb = dadosFinanceiros.fv - cmv;
             const mlb = dadosFinanceiros.fv > 0 ? (lb / dadosFinanceiros.fv) * 100 : 0;
             const dt = dadosFinanceiros.cf + dadosFinanceiros.cv + dadosFinanceiros.oc;
             const ll = lb - dt;
             const mll = dadosFinanceiros.fv > 0 ? (ll / dadosFinanceiros.fv) * 100 : 0;
             const mc = dadosFinanceiros.fv > 0 ? ((dadosFinanceiros.fv - dadosFinanceiros.cv - cmv) / dadosFinanceiros.fv) * 100 : 0;
             const pe = mc > 0 ? dadosFinanceiros.cf / (mc / 100) : 0;
             const em = (dadosFinanceiros.ei + dadosFinanceiros.ef) / 2;
             const ge = em > 0 ? cmv / em : 0;
             const tm = dadosFinanceiros.n > 0 ? dadosFinanceiros.fv / dadosFinanceiros.n : 0;
             const fc = dadosFinanceiros.entradas - dadosFinanceiros.saidas;
             const roi = dadosFinanceiros.inv > 0 ? (ll / dadosFinanceiros.inv) * 100 : 0;
             const precoSugerido = dadosFinanceiros.unidadesCompradas > 0 ? (dadosFinanceiros.ccp / dadosFinanceiros.unidadesCompradas) * dadosFinanceiros.mk : 0;
             
             dadosCalculados = { cmv, lb, mlb, dt, ll, mll, mc, pe, em, ge, tm, fc, roi, precoSugerido };
             return dadosCalculados;
        }

        // Sincroniza√ß√£o (Local -> Cloud)
        function syncWithFirebase() {
            if (!currentUser || !db) return;
            
            updateSyncStatus('syncing', 'Salvando...');
            
            const payload = {
                dadosAtuais: { 
                    dados: dadosFinanceiros, 
                    calculados: dadosCalculados 
                },
                historico: periodosHistorico,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                email: currentUser.email,
                name: currentUser.displayName || null // Salva o nome tamb√©m no banco de dados
            };

            db.collection('simulacoes').doc(currentUser.uid).set(payload, { merge: true })
                .then(() => updateSyncStatus('online', 'Salvo na Nuvem'))
                .catch(err => {
                    console.error(err);
                    updateSyncStatus('offline', 'Erro ao salvar');
                });
        }

        function updateSyncStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            txt.innerText = text;
            dot.className = 'status-dot ' + status;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializa Firebase e Auth
            initFirebase();

            // Mant√©m funcionamento offline inicial
            carregarDadosSalvos();

            // Adicionar event listeners para c√°lculo autom√°tico
            const inputs = document.querySelectorAll('#financial-form input');
            let timeout;
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        if (document.getElementById('fv').value) {
                            calcularIndicadores();
                        }
                    }, 500);
                });
            });
            
            window.addEventListener('online', () => updateSyncStatus('online', 'Online'));
            window.addEventListener('offline', () => updateSyncStatus('offline', 'Offline'));
        });
    </script>
</body>
</html>